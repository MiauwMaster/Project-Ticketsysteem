
@using iTextSharp.text;
@using iTextSharp.text.pdf;
@using QRCoder;
@{
    //Variables
    var artiest = "";
    var foto = "";
    DateTime datum = new DateTime();
    var zaal = 0;
    var prijs = Decimal.One;
    var aantalTicketsInBestelling = 0;
    int ticketID = 0;
    var concertID = Session["concertid"];
    int bestelNR = Convert.ToInt32(Session["bestelnummer"]); // uit vorige pagina halen

    // Open database connection
    var db = Database.Open("Database");

    // SQL Statement
    // Concert info
    var statement = "SELECT * FROM Concerten WHERE id = @0";
    var data = db.QuerySingle(statement, concertID); // ID FROM LAST PAGE

    // Aantal tickets
    var statement2 = "SELECT COUNT(bestel_nr) FROM Tickets WHERE bestel_nr = @0";
    var data2 = db.QueryValue(statement2, bestelNR);

    //Eerste ID met bestelnummer
    var statement3 = "SELECT id FROM Tickets WHERE bestel_nr = @0";
    var data3 = db.QuerySingle(statement3, bestelNR);

    //Fill variables
    artiest = data.naam;
    foto += Server.MapPath("~");
    foto += data.foto;
    datum = data.datum;
    zaal = data.zaal_nr;
    prijs = data.prijs;
    aantalTicketsInBestelling = data2;
    ticketID = data3.id;


    Document doc = new Document(PageSize.A4.Rotate(), 25, 25, 30, 30);

    PdfWriter writer = PdfWriter.GetInstance(doc, new FileStream(Server.MapPath("Tickets") + "\\" + bestelNR + ".pdf", FileMode.Create));
    doc.Open();

    // Fonts
    var titleFont = FontFactory.GetFont("Verdana", 40, BaseColor.BLACK);
    var parFont = FontFactory.GetFont("Verdana", 15, BaseColor.BLACK);

    for (int i = 0; i < aantalTicketsInBestelling; i++)
    {
        // Create new page for each ticket
        doc.NewPage();

        // Print artist name as ticket title
        var title = new phrase(artiest, titleFont);
        //title.Alignment = 1;
        //doc.Add(title);

        // Horizontal line
        var line = new Paragraph("______________________", titleFont);
        line.Alignment = Element.ALIGN_CENTER;
        //doc.Add(line);

        //Generate QR Code
        QRCodeGenerator qrGenerator = new QRCodeGenerator();
        QRCodeData qrCodeData = qrGenerator.CreateQrCode("TODO: URL invoegen" + ticketID, QRCodeGenerator.ECCLevel.Q);
        QRCode qrCode = new QRCode(qrCodeData);
        System.Drawing.Image qrCodeImage = qrCode.GetGraphic(5);

        //New line
        //doc.Add(new Chunk("\n"));

        // print QR Code
        Image jpg = Image.GetInstance(qrCodeImage, BaseColor.WHITE);
        //jpg.Alignment = Image.TEXTWRAP | Image.ALIGN_LEFT;
        //doc.Add(jpg);

        // print rest of ticket info
        var datump = new PdfPCell(new Phrase(@"Datum: " + datum.ToString("dd MMMM, yyyy"), parFont));
        //datup.Alignment = Element.ALIGN_CENTER;
        //doc.Add(datump);

        var zaalp = new PdfPCell(new Phrase("Zaal: " + zaal.ToString(), parFont));
        //zaalp.Alignment = Element.ALIGN_CENTER;
        //doc.Add(zaalp);

        //Checken op korting
        var statement4 = "SELECT kindOf65plus FROM Tickets WHERE id = @0";
        var korting = db.QueryValue(statement4, ticketID);

        paragraph prijsp = "";
        if (korting == false)
        {
            var prijsp = new PdfPCell(new Phrase("Prijs: €" + prijs.ToString(), parFont));
            //prijsp.Alignment = Element.ALIGN_CENTER;
            //doc.Add(prijsp);
        }

        else if (korting == true)
        {
            decimal prijsMetKorting = prijs * 0.9m;
            var prijsp = new PdfPCell(new Phrase("Prijs: €" + prijsMetKorting.ToString(), parFont));
            //prijsp.Alignment = Element.ALIGN_CENTER;
            //doc.Add(prijsp);
        }

        
        image artist = null;
        // Add artist photo
        if (foto != null)
        {
            Image artist = Image.GetInstance(foto);
            artist.ScaleToFit(200f, 200f);
            //artist.Alignment = Image.TEXTWRAP | Image.ALIGN_RIGHT;
            //doc.Add(artist);
        }



        PdfPTable table = new PdfPTable(3);
        table.DefaultCell.Border = Rectangle.NO_BORDER;

        PdfPCell titel = new PdfPCell(title);
        titel.Colspan = 3;
        titel.HorizontalAlignment = 1;
        
        table.AddCell(titel);
        table.AddCell(jpg);
        table.AddCell(datump + "\n" + zaalp + "\n" prijsp);
        table.AddCell(artist);

        doc.Add(table);







        // TicketID for QR url ophogen
        ticketID += 1;//steeds met 1 verhoogd per ticket zodat je het juiste ticketID krijgt, kan misschien wel simpeler gemaakt worden
    }

    doc.Close();

    Response.Clear();

    string filePath = Server.MapPath("Tickets") + "//" + bestelNR.ToString() + ".pdf";

    Response.ContentType = "application/pdf";

    Response.WriteFile(filePath);
}
@data.foto



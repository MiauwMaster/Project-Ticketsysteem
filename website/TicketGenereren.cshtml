
@using iTextSharp.text;
@using iTextSharp.text.pdf;
@using QRCoder;
@using System.Net.Mail;
@{
    //Variables
    var artiest = "";
    var foto = "";
    var userEmail = Session["email"];
    DateTime datum = new DateTime();
    var zaal = 0;
    var prijs = Decimal.One;
    var aantalTicketsInBestelling = 0;
    int ticketID = 0;
    var concertID = Session["concertid"];
    int bestelNR = Convert.ToInt32(Session["bestelnummer"]); // uit vorige pagina halen

    // Open database connection
    var db = Database.Open("Database");

    // SQL Statement
    // Concert info
    var statement = "SELECT * FROM Concerten WHERE id = @0";
    var data = db.QuerySingle(statement, concertID); // ID FROM LAST PAGE

    // Aantal tickets
    var statement2 = "SELECT COUNT(bestel_nr) FROM Tickets WHERE bestel_nr = @0";
    var data2 = db.QueryValue(statement2, bestelNR);

    //Eerste ID met bestelnummer
    var statement3 = "SELECT id FROM Tickets WHERE bestel_nr = @0";
    var data3 = db.QuerySingle(statement3, bestelNR);

    //Fill variables
    artiest = data.naam;
    foto += Server.MapPath("~");
    foto += data.foto;
    datum = data.datum;
    zaal = data.zaal_nr;
    prijs = data.prijs;
    aantalTicketsInBestelling = data2;
    ticketID = data3.id;


    Document doc = new Document(PageSize.A4.Rotate(), 25, 25, 30, 30);

    PdfWriter writer = PdfWriter.GetInstance(doc, new FileStream(Server.MapPath("Tickets") + "\\" + bestelNR + ".pdf", FileMode.Create));
    doc.Open();

    // Fonts
    var titleFont = FontFactory.GetFont("Verdana", 40, BaseColor.BLACK);
    var parFont = FontFactory.GetFont("Verdana", 15, BaseColor.BLACK);

    for (int i = 0; i < aantalTicketsInBestelling; i++)
    {
        // Create new page for each ticket
        doc.NewPage();

        // Print artist name as ticket title
        var title = new Phrase(artiest, titleFont);

        //Generate QR Code
        QRCodeGenerator qrGenerator = new QRCodeGenerator();
        QRCodeData qrCodeData = qrGenerator.CreateQrCode("TODO: URL invoegen" + ticketID, QRCodeGenerator.ECCLevel.Q);
        QRCode qrCode = new QRCode(qrCodeData);
        System.Drawing.Image qrCodeImage = qrCode.GetGraphic(5);

        // print QR Code
        Image jpg = Image.GetInstance(qrCodeImage, BaseColor.WHITE);

        // print rest of ticket info
        var datump = new Phrase(@"Datum: " + datum.ToString("dd MMMM, yyyy"), parFont);
        var zaalp = new Phrase("Zaal: " + zaal.ToString(), parFont);


        //Checken op korting
        var statement4 = "SELECT kindOf65plus FROM Tickets WHERE id = @0";
        var korting = db.QueryValue(statement4, ticketID);

        Phrase prijsp = new Phrase();
        if (korting == false)
        {
            prijsp = new Phrase("Prijs: €" + prijs.ToString(), parFont);
        }

        else if (korting == true)
        {
            decimal prijsMetKorting = prijs * 0.9m;
            prijsp = new Phrase("Prijs: €" + prijsMetKorting.ToString(), parFont);
        }

        // Add artist photo
        Image artist = null;
        if (foto != null)
        {
            artist = Image.GetInstance(foto);
            artist.ScaleToFit(150f, 150f);
        }



        PdfPTable table = new PdfPTable(3);
        table.DefaultCell.Border = Rectangle.NO_BORDER;

        PdfPCell titel = new PdfPCell(title);
        titel.Colspan = 3;
        titel.Border = Rectangle.NO_BORDER;
        titel.FixedHeight = 50f;
        titel.HorizontalAlignment = 1;

        PdfPCell info = new PdfPCell();
        info.Border = Rectangle.NO_BORDER;
        info.VerticalAlignment = 1;
        info.AddElement(datump);
        info.AddElement(zaalp);
        info.AddElement(prijsp);
        info.HorizontalAlignment = Element.ALIGN_MIDDLE;


        table.AddCell(titel);
        table.AddCell(jpg);
        table.AddCell(info);
        table.AddCell(artist);

        doc.Add(table);







        // TicketID for QR url ophogen
        ticketID += 1;//steeds met 1 verhoogd per ticket zodat je het juiste ticketID krijgt, kan misschien wel simpeler gemaakt worden
    }

    doc.Close();

    Response.Clear();

    string filePath = Server.MapPath("Tickets") + "//" + bestelNR.ToString() + ".pdf";

    Response.ContentType = "application/pdf";

    Response.WriteFile(filePath);

    try
    {
        MailAddress mailfrom = new MailAddress("ticketsysteemnhl@gmail.com");
        MailAddress mailto = new MailAddress(userEmail.ToString());
        MailMessage newmsg = new MailMessage(mailfrom, mailto);

        newmsg.Subject = "Uw Ticket(s)";
        newmsg.Body = "Hartelijk bedankt voor het bestellen van ticket(s) voor het concert: " + artiest + ". " + "In de bijlage vind u een pdf met uw tickets, deze dient u uit te printen en te laten zien bij binnenkomst";

        //For File Attachment, more file can also be attached
        Attachment att = new Attachment(Server.MapPath("Tickets") + "\\" + bestelNR + ".pdf");
        newmsg.Attachments.Add(att);

        SmtpClient smtp = new SmtpClient("smtp.gmail.com", 587);
        smtp.UseDefaultCredentials = false;
        smtp.Credentials = new NetworkCredential("ticketsysteemnhl@gmail.com", "waltersamplonius");
        smtp.EnableSsl = true;
        smtp.Send(newmsg);
    }
    catch (Exception ex)
    {
        Response.Write(ex.Message);
    }
}
@data.foto


